<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel =stylesheet href="./feedPage.css">
  </head>
  <body>
    <div class="text-end p-2">
        <a href="/login.html" class="btn btn-danger w-25"  onclick="logout()">Log Out</a>
        <a href="/post.html" class="btn btn-primary w-25">New Post</a>
    </div>

    <div class="allPosts">
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.min.js" integrity="sha384-G/EV+4j2dNv+tEPo3++6LCgdCROaejBqfUeNjuKAiuXbjrxilcCdDz6ZAVfHWe1Y" crossorigin="anonymous"></script>
    <script>
      const userID = localStorage.getItem("UserID");

      if(!userID){
        alert("Please log in first");
        window.location.href = "/login.html";
      }

      async function loadFeed(){
        try{
          const res = await fetch(`http://localhost:3000/getMyPosts?UserID=${userID}`);
          if(!res.ok) throw new Error("failed to fetch Posts");
          const posts = await res.json();

          const allPostsDiv = document.querySelector(".allPosts");
          allPostsDiv.innerHTML = "";

          if (posts.length === 0) {
            allPostsDiv.innerHTML = `<p class="text-center text-muted">No posts yet ðŸ˜´</p>`;
            return;
          }

          posts.forEach(post => {
            const postDiv = document.createElement("div");
            postDiv.classList.add("post", "p-3", "mb-3", "border", "rounded-3", "shadow-sm");

            const words = post.postDescription.split(" ");
            const preview = words.length > 40 ? words.slice(0, 40).join(" ") + "..." : post.postDescription;

            postDiv.innerHTML = `
              <h3>${post.postTitle}</h3>
              <p>${preview}</p>
              <a href="/dp.html" class="btn btn-outline-primary viewPostBtn" onclick="viewPost(${post.ID})">View Post</a>
            `;
            allPostsDiv.appendChild(postDiv);
          });
        }
        catch(err){
          console.error(err);
          alert("Something went wrong while loading your feed!");
        }
      }
      function viewPost(postID){
        localStorage.setItem("PostID",postID);
        window.location.href = "/dp.html";
      }
      function logout() {
        localStorage.removeItem("UserID");
      }
      loadFeed();
    </script>
  </body>
</html>